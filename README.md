# Тестовое задание на позицию Middle+/Senior Php Developer


## Вводная часть

<p>Цель данного тестового задания — проверить ваше владение Symfony и навыки проектирования приложений.</p>  
<p>Хотя в рамках задания не оцениваются навыки верстки или знания JS-фреймворков, просим вас постараться воспроизвести визуальную структуру страниц, как это показано на схемах.</p>  

### Что предлагается сделать
<p>В качестве тестового задания предлагается реализовать примитивнейшее приложение позволяющее совершить покупку в импровизированном интернет-магазине.</p>

![scheme.png](https://github.com/vladpopov99/test-case/blob/master/.docker/img/scheme.png)

### Порядок выполнения тестового задания:

1. Ознакомьтесь с данной документацией, определите то какие компоненты и в каком порядке следует реализовать
2. Скачайте проект из данного репозитория и запустите его сборку при помощи команды `docker compose up`
3. Подключите PostgreSQL в виде контейнера в существующий docker-compose.yml (и при необходимости, добавьте дополнительные контейнеры которые могут вам понадобится) и разверните в нем исходный дамп из файла dump.sql
4. Реализуйте тестовое задание. Ваша рабочая область - это директория: `/src`, в корне проекта
5. Подготовьте миграции средствами symfony и настройте контейнер `container-testcase` так, чтобы при его сборке также накатывались созданные вами миграции
6. Подготовьте Pull Request со всеми изменениями и направьте его на ветку `master`. Название должно быть сделано по шаблону: "дата: ФИО", например - `01.01.2025: Иванов Иван Иванович`

### Что обязательно должно быть выполнено:

- Логика приложения работает корректно от главной и до страницы успешной покупки;
- **В качестве базы данных используется только PostgreSQL**
- Отсутствуют прямые обращения к базе данных - все взаимодействие происходит через ORM (допускается использование queryBuilder);
- Реализовано кэширование всех запросов к БД и внешнему апи (`container-stub`)
- Взаимодействие с сервис-контейнером `container-stub` (эмулирующем обращения к внешним сервисам доставки) организовано через написанные вами клиенты (services.yaml);
- Созданные вами компоненты покрыты phpunit-тестами
- Реализованы миграции в БД

## Начальная структура базы данных:

> [!NOTE]
> Исходный дамп лежит в корне проекта, в файле dump.sql

> [!NOTE]
> Ниже приводится описание исходной структуры данных поставляемой вместе, с тестовым заданием. В процессе выполнения задачи, вам понадобится создавать новые таблички (как минимум 2), выставлять внешние ключи и индексы - все эти изменения должны быть оформлены в виде миграций 

<p><b>carts</b> - таблица содержит информацию о корзинах пользователей <b>(у каждого пользователя может быть несколько корзин, однако активная только созданная последней, со значением колонки is_pay == 0)</b></p>
<ul>
    <li>"id" - идентфикатор корзины</li>
    <li>"user_id" - идентификатор пользователя к которому привязана корзина</li>
    <li>"delivery_service_id" - идентификатор службы доставки из таблицы public.delivery_services</li>
    <li>"payment_service_id" - идентификатор платежной системы из таблицы public.payment_services</li>
    <li>"delivery_price"  - стоимость доставки</li>
    <li>"delivery_min_days" - минимальное время доставки (в днях) </li>
    <li>"delivery_max_days" - максимальное время доставки (в днях) </li>
    <li>"created_at" - таймштамп создания корзины</li>
    <li>"is_pay" - оплачена корзина или нет</li>
    <li>"total_payment_sum" - зафиксированная сумма к оплате (общая цена добавленных продуктов + стоимость доставки)</li>
</ul>


<p><b>products</b> - таблица содержит данные о продуктах;</p>
<ul>
    <li>"id" - идентификатор продукта</li>
    <li>"name" - название продукта</li>
    <li>"image" - ссылка на картинку продукта (найдите и добавьте произвольные картинки по своему вкусу)</li>
    <li>"price" - стоимость товара</li>
    <li>"weight" - вес товара</li>
</ul>

<p><b>delivery_service</b> - таблица содержит данные о зарегистрированных, в системе, службах доставки;</p>
<ul>
    <li>"id" - идентификатор службы доставки</li>
    <li>"code" - символьный код службы доставки</li>
    <li>"name" - название службы доставки</li>
</ul>

<p><b>payment_services</b> - таблица содержит данные о платежных системах поддерживаемых в приложении</p>
<ul>
    <li>"id" - идентификатор платежной системы</li>
    <li>"name" - название платежной системы</li>
</ul>


<br />

## Компоненты которые следует реализовать:
### Главная страница

![mainpage_unauth.png](https://github.com/vladpopov99/test-case/blob/master/.docker/img/mainpage_unauth.png)

![mainpage_auth.png](https://github.com/vladpopov99/test-case/blob/master/.docker/img/mainpage_auth.png)

### Требования к странице:

<p><b>URL:</b> /</p>

<p>Страница должна содержать информацию о доступных товарах и предоставлять возможность перехода на страницы авторизации/регистрации или корзины, в зависимости от статуса пользователя.</p>

<p><b>Шапка:</b></p>
<ul>
<li><b>Для неавторизованных пользователей:</b> ссылка на страницу авторизации/регистрации.</li>
<li><b>Для авторизованных пользователей:</b> ссылка на корзину с отображением общей стоимости добавленных товаров.</li>
</ul>

<p>Каждое превью карточки товара должно включать:</p>
<ul>
    <li><b>Название продукта</b> - значение из колонки products.name</li>
    <li><b>Изображение товара</b> - значение из колонки products.image</li>
    <li><b>Цена товара</b> - значение из колонки products.price</li>
    <li><b>Кнопка для добавления товара в корзину</b> - синхронный POST-запрос, реализация AJAX не обязательна.</li>
</ul>

> [!WARNING]
> Кнопка добавления товара в корзину, должна быть видима только для авторизованного пользователя (ROLE_USER), в ином случае она должна быть скрыта.

<br />

### Страница авторизации/регистрации

<p><b>URL:</b> /login</p>

<p>Для создания функционала страницы используйте стандартный компонент symfony/security-bundle </p>
<p>Внешний вид страницы может быть абсолютно произвольный - главное чтобы пользователь мог регистрироваться и авторизовываться (допустимо чтобы было две раздельные страницы)</p> 

<br />

### Страница корзины

> [!CAUTION]
> данная страница должна быть закрыта файерволом и недоступна для неавторизованного пользователя

> [!CAUTION]
> при заходе не авторизованного пользователя должен происходить редирект на главную страницу

![cart.png](https://github.com/vladpopov99/test-case/blob/master/.docker/img/cart.png)

### Требования к странице:

<p><b>URL:</b> /checkout/</p>

<p>Страница корзины содержит список добавленных пользователем продуктов</p>
<p>Структура страницы:</p>

<p><b>Шапка:</b></p>

<ul>
    <li><b>имя пользователя</b> - в элемент нужно вывести username текущего авторизованного пользователя</li>
</ul>

<p><b>Контентная область:</b></p>

<p><b>Список добавленных товаров</b> - каждый элемент списка должен содержать:<p> 
<ul>
    <li><b>изображение продукта</b> - значение из колонки products.image</li> 
    <li><b>название</b> - значение из колонки products.name</li> 
    <li><b>цена</b> - значение из колонки products.price</li> 
    <li><b>добавленное количество</b> - аггрегированное количество добавленного товара</li> 
    <li><b>кнопка удаления товара из корзины</b> - нажатие на кнопку удаляет привязку товара к корзине</li> 
</ul>

<p><b>Выбрать способ доставки</b> - при нажатии переводит пользовател на страницу выбора доставки<p> 

> [!WARNING]
> Важная деталь: у пользователя может быть множество ранее созданных корзин, однако, текущей корзиной пользователя должна являться. та корзина, которая была создана последней и не имеет статус "оплачена"

<br />

### Страница выбора доставки

> [!CAUTION]
> данная страница должна быть закрыта файерволом и недоступна для неавторизованного пользователя

> [!CAUTION]
> при заходе неавторизованного пользователя должен происходить редирект на главную страницу

> [!WARNING]
> не должно быть возможности напрямую зайти на эту страницу минуя страницу корзины. поэтому, в случае, если пользователь заходит по прямой ссылке то должен сработать редирект на страницу "корзина". Подсказка: проверяйте заголовки refferer

<img src="https://github.com/vladpopov99/test-case/blob/master/.docker/img/delivery.png">

### Требования к странице:

<p><b>URL:</b> /checkout/delivery/</p>

<p>Страница выбора доставки позволяет пользователю посмотреть стоимость/время доставки и выбрать одну из транспортных компаний, предложенных в списке.</p>
<p>Список транспортных компаний формируется на основе записей в таблице: delivery_services</p>

<p>Структура страницы:</p>

<p><b>Шапка:</b></p>

<ul>
    <li><b>кнопка возвращения в корзину</b> - при нажатии переводит пользователя на страницу корзины</li>
    <li><b>имя пользователя</b> - в элемент нужно вывести username текущего авторизованного пользователя</li>
</ul>

<p><b>Контентная область:</b></p>

<p><b>Список транспортных компаний</b> - каждый элемент списка должен содержать:<p> 
<ul>
    <li><b>название транспортной компании</b> - значение из колонки delivery_services.name</li> 
    <li><b>стоимость доставки</b> - значение возвращенное от внешнего сервиса (см. ниже curl который поможет получить данные для cdek и fivepost)</li> 
    <li><b>срок доставки</b> - собранное значение возвращаемое из внешнего сервиса </li>
    <li><b>кнопка выбрать</b> - нажатие на кнопку позволяет зафиксировать выбранную службу доставки в заказе, после чего пользователь переходит на страницу выбора оплаты</li> 
</ul>

> [!WARNING]
> При возвращении со страницы выбора оплаты, ранее выбранная транспортная компания должна иметь "подсвеченую" стилями кнопку.

> [!NOTE]
> Перед переходом на страницу выбора оплаты, вам необходимо зафиксировать следующие данные в таблице **carts** : delivery_service_id - идентификатор транспортной компании, delivery_price - сумму доставки, delivery_min_days - минимальный период доставки, delivery_max_days - максимальный период доставки


#### CURL запросы к сервис-контейнеру container-testcase, эмулирующему ответ от внешнего апи

##### Транспортная компания CDEK:

```php
    curl --location 'http://<укажите хост сервиса container-testcase>/delivery/cdek' \
    --header 'Content-Type: application/json' \
    --data '{
        "username": "cdek-user-01", 
        "password": "123456789", 
        "weight": "5" 
    }'

    // Структура ответа:
    // Успешный ответ 
    {
        "status": true,
        "data": {
            "message": "OK",
            "price": "90",
            "delivery_min_days": "1",
            "delivery_max_days": "5"
        }
    }
    // Неуспешный ответ
    {
        "status": false,
        "data": {
            "message": "Неверный логин или пароль"
        }
    }
```

##### Транспортная компания FivePost:

```php

    curl --location 'http://<укажите хост сервиса container-testcase>/delivery/fivepost' \
    --header 'apiKey: 448ed7416fce2cb66c2855d182b1ba3df1e90016d' \ 
    --header 'Content-Type: application/json' \
    --data '{
        "weight": "50"
    }'

    // Успешный ответ
    {
        "status": 200,
        "data": {
            "message": 200,
            "price": 50,
            "delivery_min_days": 5,
            "delivery_max_days": 24
        }
    }
    // Неуспешный ответ
    {
        "status": 403,
        "data": {
            "message": "Неверный apiKey"
        }
    }
```

<br />

### Страница выбора оплаты

> [!CAUTION]
> данная страница должна быть закрыта файерволом и недоступна для неавторизованного пользователя

> [!CAUTION]
> при заходе неавторизованного пользователя должен происходить редирект на главную страницу

> [!WARNING]
> не должно быть возможности напрямую зайти на эту страницу минуя страницу выбора доставки. поэтому, в случае, если пользователь заходит по прямой ссылке то должен сработать редирект на страницу "корзина". Подсказка: проверяйте заголовки refferer


<img src="https://github.com/vladpopov99/test-case/raw/master/.docker/img/payment.png">

### Требования к странице:

<p><b>URL:</b> /checkout/payments/</p>

<p>Страница позволяет пользователю выбрать желаемый способ оплаты из представленного списка</p>
<p>Список транспортных компаний формируется на основе записей в таблице: payment_services</p>

<p>Структура страницы:</p>

<p><b>Шапка:</b></p>

<ul>
    <li><b>кнопка возвращения на страницу выбора доставки</b> - при нажатии переводит пользователя на выбор доставки</li>
    <li><b>имя пользователя</b> - в элемент нужно вывести username текущего авторизованного пользователя</li>
</ul>

<p><b>Контентная область:</b></p>

<p><b>Список платежных систем</b> - каждый элемент списка должен содержать:<p> 
<ul>
    <li><b>название платежной системы</b> - значение из колонки payment_services.name</li> 
    <li><b>кнопка оплатить</b> - нажатие на кнопку позволяет зафиксировать в заказе выбранную платежную систему, после чего пользователь переходит на страницу с сообщением об успешной оплате</li> 
</ul>

> [!NOTE]
> Перед переходом на страницу успешной оплаты, вам необходимо зафиксировать следующие данные в таблице **carts** : payment_service_id - идентификатор выбранной платежной системы


<br />

### Страница сообщения об успешной оплате

<img src="https://github.com/vladpopov99/test-case/blob/master/.docker/img/success.png">

### Требования к странице:

<p><b>URL:</b> /checkout/success-page/</p>

<p>Страница сообщает пользователю о том что заказ был оплачен и передан в службу доставки</p>

<p>Структура страницы:</p>

<p><b>Шапка:</b></p>

<ul>
    <li><b>имя пользователя</b> - в элемент нужно вывести username текущего авторизованного пользователя</li>
</ul>

<p><b>Контентная область:</b></p>

<ul>
    <li><b>Ваш заказ №</b> - идентификатор корзины. колонка carts.id</li> 
    <li><b>Дата/время заказа:</b> - идентификатор корзины. колонка carts.created_at</li> 
    <li><b>Будет доставлен в срок</b> - значение собранное из данных колонок carts.delivery_min_days и carts.delivery_max_days (например: "от 1 до 5 д.")</li> 
    <li><b>Стоимость товаров</b> - аггрегированное значение стоимости всех товаров привязанных к текущей корзине</li> 
    <li><b>Стоимость доставки</b> - значение из колонки carts.delivery_price</li> 
    <li><b>Оплаченная сумма</b> - общая сумма заказа вместе с доставкой из колонки carts.total_payment_sum</li> 
    <li><b>кнопка "на главную страницу"</b> - нажатие на кнопку переводит пользователя на главную страницу</li> 
</ul>

> [!NOTE]
> Важно учитывать следующий момент: при достижении пользователем страницы успешной оплаты, следует произвести фиксацию состояния корзины, путем выставления значения 1 в колонке carts.is_pay и проконтролировать, что при последующем заходе на главную страницу, у пользователя была создана новая корзина